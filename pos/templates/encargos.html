{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Seccion de Encargos</title>
    <style>
      .container-body-encargos {
        margin-top: 90px;
      }

      .table th,
      .table td {
        vertical-align: middle;
      }
      .color-green {
        color: #008000;
      }
      .color-price {
        color: rgb(0, 110, 255);
      }
      .color-grey {
        color: #bbc3c9;
      }
      .card-body img {
        max-width: 80px;
        max-height: 80px;
        float: right;
      }
    </style>
  </head>

  <body>
    {% load static %} {% include 'layouts/navbar.html' %}

    <!-- Contenedor para la tabla principal (Control de encargos) -->
    <div class="container container-body-encargos">
      <h1>Tabla de Encargos</h1>

      {% comment %}
      <button
        type="button"
        class="btn btn-primary mt-2"
        data-bs-toggle="modal"
        data-bs-target="#modalAgregarEncargo"
      >
        Agregar Encargo
      </button>
      {% endcomment %}

      <ul class="nav nav-tabs mt-3" id="tabEncargos" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="completado-tab"
            data-toggle="tab"
            href="#completado"
            role="tab"
            aria-controls="completado"
            aria-selected="false"
            >Por Entregar</a
          >
        </li>

        <li class="nav-item">
          <a
            class="nav-link"
            id="proceso-tab"
            data-toggle="tab"
            href="#proceso"
            role="tab"
            aria-controls="proceso"
            aria-selected="false"
            >En Proceso</a
          >
        </li>

        <li class="nav-item">
          <a
            class="nav-link"
            id="entregado-tab"
            data-toggle="tab"
            href="#entregado"
            role="tab"
            aria-controls="entregado"
            aria-selected="false"
            >Entregados</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="encargo-tab"
            data-toggle="tab"
            href="#encargo"
            role="tab"
            aria-controls="encargo"
            aria-selected="true"
            >Todos</a
          >
        </li>
      </ul>

      <div class="tab-content" id="contenidoEncargos">
        <div
          class="tab-pane fade"
          id="encargo"
          role="tabpanel"
          aria-labelledby="encargo-tab"
        >
          <table class="table">
            <thead>
              <tr>
                <th class="color-grey">Folio del Encargo</th>
                <th>Cliente</th>
                <th>Fecha de Encargo</th>
                <th>Fecha de Entrega</th>
                <!--<th class="color-price">Costo</th>>-->
                <th>Observaciones</th>
                {% comment %}
                <th>Acciones</th>
                {% endcomment %}
              </tr>
            </thead>

            <tbody>
              {% for encargo in encargos_encargo %}
              <tr>
                <td class="color-grey">{{ encargo.Folio }}</td>
                <td>{{ encargo.cliente }}</td>
                <td>{{ encargo.fecha_encargo }}</td>
                <td>{{ encargo.fecha_entrega }}</td>
                <!-- <td>{{ encargo.costo }}</td> -->
                <td>{{ encargo.observaciones }}</td>
                <!--<td><button class="btn-cambiar-proceso btn btn-success" data-id="{{ encargo.id }}">Cambiar Estado</button></td>-->
                {% comment %}
                <td>
                  <button
                    class="btn-cambiar-encargo btn btn-primary"
                    data-id="{{ encargo.id }}"
                  >
                    Cambiar Encargo
                  </button>
                </td>
                {% endcomment %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div
          class="tab-pane fade"
          id="proceso"
          role="tabpanel"
          aria-labelledby="proceso-tab"
        >
          <table class="table">
            <thead>
              <tr>
                <th class="color-grey">Folio del Encargo</th>
                <th>Cliente</th>
                <!-- <th>Fecha de Encargo</th> -->
                <th>Fecha de Entrega</th>
                <!-- <th>Costo</th> -->
                <th>Observaciones</th>
                {% comment %}
                <th>Acciones</th>
                {% endcomment %}
              </tr>
            </thead>

            <tbody>
              {% for encargo in encargos_proceso %}
              <tr>
                <td class="color-grey">{{ encargo.Folio }}</td>
                <td>{{ encargo.cliente }}</td>
                <!-- <td>{{ encargo.fecha_encargo }}</td> -->
                <td>{{ encargo.fecha_entrega }}</td>
                <!-- <td>{{ encargo.costo }}</td> -->
                <td>{{ encargo.observaciones }}</td>
                {% comment %}
                <td>
                  <button
                    class="btn-cambiar-encargo btn btn-primary"
                    data-id="{{ encargo.id }}"
                  >
                    Cambiar Encargo
                  </button>
                </td>
                {% endcomment %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div
          class="tab-pane fade show active"
          id="completado"
          role="tabpanel"
          aria-labelledby="completado-tab"
        >
          <table class="table">
            <thead>
              <tr>
                <th class="color-grey">Folio del Encargo</th>
                <th>cliente</th>
                <!-- <th>Fecha de Encargo</th> -->
                <th>Fecha de Entrega</th>
                <th>Adeudo</th>
                <th>Estado de Pago</th>
                <th>Actualizar Encargo</th>
              </tr>
            </thead>

            <tbody>
              {% for encargo in encargos_completado %}
              <tr>
                <td class="color-grey">{{ encargo.Folio }}</td>
                <td>{{ encargo.cliente }}</td>
                <!-- <td>{{ encargo.fecha_encargo }}</td> -->
                <td>{{ encargo.fecha_entrega }}</td>
                <td>{{ encargo.adeudo }}</td>
                <td>
                  {% if encargo.adeudo == 0 %}
                  <img
                    src="{% static 'img/icons8-comprobado-30.png' %}"
                    alt="comprobado"
                  />
                  {% else %}
                  <img src="{% static 'img/icons8-no-30.png' %}" alt="no" />
                  {% endif %}
                </td>
                <td>
                  <button
                    class="btn-cambiar-encargo btn btn-primary"
                    data-id="{{ encargo.id }}"
                  >
                    Cambiar Encargo
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div
          class="tab-pane fade"
          id="entregado"
          role="tabpanel"
          aria-labelledby="completado-tab"
        >
          <table class="table">
            <thead>
              <tr>
                <th class="color-grey">Folio del Encargo</th>

                <th>cliente</th>
                <th>Fecha de Entrega</th>
                <th>Costo</th>
                <th>Estado de Pago</th>
                {% comment %}
                <th></th>
                {% endcomment %}
              </tr>
            </thead>

            <tbody>
              {% for encargo in encargos_entregados %}
              <tr>
                <td class="color-grey">{{ encargo.Folio }}</td>
                <td>{{ encargo.cliente }}</td>
                <td>{{ encargo.fecha_entrega }}</td>
                <td>{{ encargo.costo }}</td>
                <td>
                  {% if encargo.adeudo == 0 %}
                  <img
                    src="{% static 'img/icons8-comprobado-30.png' %}"
                    alt="comprobado"
                  />
                  {% else %}
                  <img src="{% static 'img/icons8-no-30.png' %}" alt="no" />
                  {% endif %}
                </td>
                {% comment %}
                <td>
                  {% if encargo.adeudo != 0 %}
                  <button
                    class="btn-cambiar-encargo btn btn-primary"
                    data-id="{{ encargo.id }}"
                  >
                    Validar encargo
                  </button>
                  {% endif %}
                </td>
                {% endcomment %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Seccion de los modal para el funcionamiento de la pagina -->
    <!-- Modal para cambiar estado -->
    <div
      class="modal fade"
      id="modalCambiarEstado"
      tabindex="-1"
      aria-labelledby="CambiarEstadoLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="CambiarEstadoLabel">
              Entregar Encargo
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body">
            <form id="formCambiarEstado">
              {% csrf_token %}
              <div class="mb-3">
                <label for="estadoPago" class="form-label"
                  >Adeudo del Encargo</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="estadoPago"
                  name="estadoPago"
                  step="0.01"
                  readonly
                />
              </div>

              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="checkboxAdeudo"
                    name="checkboxAdeudo"
                    required
                  />
                  <label class="form-check-label" for="checkboxAdeudo">
                    Entregado
                  </label>
                </div>
              </div>

              {% comment %}
              <div class="mb-3">
                <label for="nuevoAdeudo" class="form-label">Nuevo Adeudo</label>
                <input
                  type="number"
                  class="form-control"
                  id="nuevoAdeudo"
                  name="nuevoAdeudo"
                  step="0.01"
                />
              </div>
              {% endcomment %}
              <button
                type="submit"
                class="btn btn-primary"
                id="btnGuardar"
                disabled
              >
                Guardar
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para generar el pago -->
    <div
      class="modal fade"
      id="modalAgregarEncargo"
      tabindex="-1"
      aria-labelledby="modalAgregarEncargoLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalAgregarEncargoLabel">
              Agregar Encargo
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body">
            <form id="formAgregarEncargo">
              {% csrf_token %}
              <div class="mb-3">
                <label for="folio" class="form-label">Folio</label>
                <input
                  type="text"
                  class="form-control"
                  id="folio"
                  name="folio"
                  readonly
                />
              </div>

              <div class="mb-3">
                <label for="cliente" class="form-label">Clientes</label>
                <select class="form-select" id="cliente" name="cliente_id">
                  {% for cliente in clientes %}
                  <option value="{{ cliente.id }}">
                    {{ cliente.nombre }} {{ cliente.apellidos }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <div class="mb-3">
                <label for="fecha_encargo" class="form-label"
                  >Fecha de Encargo</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="fecha_encargo"
                  name="fecha_encargo"
                  value="{{ current_date }}"
                  readonly
                />
              </div>

              <div class="mb-3">
                <label for="fecha_entrega" class="form-label"
                  >Fecha de Entrega</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="fecha_entrega"
                  name="fecha_entrega"
                />
              </div>

              <div class="mb-3">
                <label for="costo" class="form-label">Costo</label>
                <input
                  type="number"
                  class="form-control"
                  id="costo"
                  name="costo"
                  step="0.01"
                />
              </div>

              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="pagadoCheckbox"
                  name="pagadoCheckbox"
                />
                <label class="form-check-label" for="pagadoCheckbox"
                  >¿Pagado?</label
                >
              </div>

              <div class="mb-3">
                <label for="anticipo" class="form-label">Anticipo</label>
                <input
                  type="number"
                  class="form-control"
                  id="anticipo"
                  name="anticipo"
                  step="0.01"
                />
              </div>

              <div class="mb-3">
                <label for="adeudo" class="form-label">Adeudo</label>
                <input
                  type="number"
                  class="form-control"
                  id="adeudo"
                  name="adeudo"
                  step="0.01"
                  readonly
                />
              </div>

              <div class="mb-3">
                <label for="forma_pago" class="form-label"
                  >Metodo de Pago</label
                >
                <select class="form-select" id="forma_pago" name="forma_pago">
                  <option value="Efectivo">Efectivo</option>
                  <option value="Tarjeta">Tarjeta</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="observaciones" class="form-label"
                  >Descripcion</label
                >
                <textarea
                  class="form-control"
                  id="observaciones"
                  name="observaciones"
                  rows="3"
                >
{{ encargo.observaciones }}</textarea
                >
              </div>

              <button type="submit" class="btn btn-primary">Guardar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para generar un ticket -->
    <div
      class="modal fade"
      id="modalTicket"
      tabindex="-1"
      aria-labelledby="modalTicketLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTicketLabel">Ticket de Venta</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body" id="ticketContent">
            <!-- Carga de contenido  -->
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cerrar
            </button>
            <!--<button type="button" class="btn btn-primary" onclick="printTickett()">Imprimir</button>-->
            <button type="button" class="btn-imprime-ticket btn btn-primary">
              Imprimir
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Seccion de notificasion -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div
        id="toastNotification"
        class="toast"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header">
          <strong class="me-auto">Notificación</strong>
          <small>Ahora</small>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>

        <div class="toast-body" id="toastBody">
          Mensaje de notificación aquí.
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Selecciona todos los botones de "Cambiar Encargo"
        var btnCambiarEstado = document.querySelectorAll(
          ".btn-cambiar-encargo"
        );

        var checkboxAdeudo = document.getElementById("checkboxAdeudo");
        var btnGuardar = document.getElementById("btnGuardar");

        // Deshabilitar el botón de guardar al inicio
        btnGuardar.setAttribute("disabled", true);

        // Manejar el cambio en el checkbox
        checkboxAdeudo.addEventListener("change", function () {
          if (checkboxAdeudo.checked) {
            btnGuardar.removeAttribute("disabled"); // Habilitar el botón de guardar si el checkbox está marcado
          } else {
            btnGuardar.setAttribute("disabled", true); // Deshabilitar el botón si el checkbox no está marcado
          }
        });

        btnCambiarEstado.forEach(function (btn) {
          btn.addEventListener("click", function () {
            var encargoId = this.dataset.id;
            var modal = $("#modalCambiarEstado");
            modal.modal("show"); // Muestra el modal

            // Realiza la solicitud GET para obtener el adeudo actual del encargo
            $.ajax({
              type: "GET",
              url: "/cambiar-estado-encargo/" + encargoId + "/",
              success: function (response) {
                // Actualiza los campos del modal con la información recibida
                $("#estadoPago").val(response.adeudo); // Mostrar el adeudo actual
                $("#selectEstado").val(response.estado); // Estado actual

                // Ajusta el campo "Nuevo Adeudo" si es necesario
                $("#nuevoAdeudo").val(response.adeudo);
              },
              error: function (xhr, errmsg, err) {
                console.log(xhr.status + ": " + xhr.responseText);
              },
            });

            // Maneja la actualización del estado cuando se envía el formulario
            $("#formCambiarEstado")
              .off("submit")
              .on("submit", function (e) {
                e.preventDefault();
                var nuevoEstado = "ENTREGADO";
                var nuevoAdeudo = $("#checkboxAdeudo").is(":checked")
                  ? "0.00"
                  : "0.00";
                var adeudoOriginal = $("#estadoPago").val();

                $.ajax({
                  type: "POST",
                  url: "/cambiar-estado-encargo/" + encargoId + "/",
                  data: {
                    estado: nuevoEstado,
                    nuevo_adeudo: nuevoAdeudo,
                    adeudo_original: adeudoOriginal,
                    csrfmiddlewaretoken: "{{ csrf_token }}",
                  },
                  success: function (response) {
                    console.log("Respuesta del servidor:", response); // Añadir para verificar la respuesta
                    if (response.success) {
                      modal.modal("hide");
                      showToast("Encargo actualizado", "success");
                      setTimeout(function () {
                        console.log("Recargando la página...");
                        location.reload(); // Recargar la página para reflejar los cambios
                      }, 1000);
                    } else {
                      console.log("Error en la respuesta del servidor");
                      showToast("Error al actualizar el encargo", "error");
                    }
                  },
                  error: function (xhr, errmsg, err) {
                    console.log(xhr.status + ": " + xhr.responseText);
                    showToast("Error al actualizar el encargo", "error");
                  },
                });
              });
          });
        });
      });

      function showToast(message, type) {
        var toast = new bootstrap.Toast(document.getElementById('toastNotification'));
        document.getElementById('toastBody').innerText = message;
        document.getElementById('toastNotification').classList.add('bg-' + type);
        toast.show();
    }
    </script>
    {% comment %} <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script> {% endcomment %}
    {% comment %}
    <script src="{% static 'js/encargo_actions.js' %}"></script>
    {% endcomment %}
  </body>
</html>
