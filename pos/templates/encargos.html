{% load static %}
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seccion de Encargos</title>
    <style>
        .mt-7, .my-7 {
            margin-top: 3.8rem !important;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .color-green {
            color: #008000;
        }
        .color-price {
            color: rgb(0, 110, 255);
        }
        .color-grey {
            color: #bbc3c9;
        }
        .card-body img {
            max-width: 80px;
            max-height: 80px;
            float: right;
        }
    </style>
</head>

<body>

    {% load static %}
    {% include 'layouts/navbar.html' %}

    <!-- Contenedor para la tabla principal (Control de encargos) -->
    <div class="container mt-7">
        <h1>Tabla de Encargos</h1>

        <button type="button" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#modalAgregarEncargo">
            Agregar Encargo
        </button>

        <ul class="nav nav-tabs mt-3" id="tabEncargos" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="encargo-tab" data-toggle="tab" href="#encargo" role="tab" aria-controls="encargo" aria-selected="true">Encargo</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="proceso-tab" data-toggle="tab" href="#proceso" role="tab" aria-controls="proceso" aria-selected="false">En Proceso</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="completado-tab" data-toggle="tab" href="#completado" role="tab" aria-controls="completado" aria-selected="false">Completado</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="entregado-tab" data-toggle="tab" href="#entregado" role="tab" aria-controls="entregado" aria-selected="false">Entregados</a>
            </li>
        </ul>

        <div class="tab-content" id="contenidoEncargos">

            <div class="tab-pane fade show active" id="encargo" role="tabpanel" aria-labelledby="encargo-tab">
                <table class="table">

                    <thead>
                        <tr>
                            <th class="color-grey">Folio del Encargo</th>
                            <th>Cliente</th>
                            <th>Fecha de Encargo</th>
                            <th>Fecha de Entrega</th>
                            <!--<th class="color-price">Costo</th>>-->
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for encargo in encargos_encargo %}
                        <tr>
                            <td class="color-grey">{{ encargo.Folio }}</td>
                            <td>{{ encargo.cliente }}</td>
                            <td>{{ encargo.fecha_encargo }}</td>
                            <td>{{ encargo.fecha_entrega }}</td>
                            <!-- <td>{{ encargo.costo }}</td> -->
                            <td>{{ encargo.observaciones }}</td>
                            <!--<td><button class="btn-cambiar-proceso btn btn-success" data-id="{{ encargo.id }}">Cambiar Estado</button></td>-->
                            <td>
                                <button class="btn-cambiar-encargo btn btn-primary" data-id="{{ encargo.id }}">Cambiar Encargo</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>

            <div class="tab-pane fade" id="proceso" role="tabpanel" aria-labelledby="proceso-tab">
                <table class="table">

                    <thead>
                        <tr>
                            <th class="color-grey">Folio del Encargo</th>
                            <th>Cliente</th>
                            <!-- <th>Fecha de Encargo</th> -->
                            <th>Fecha de Entrega</th>
                            <!-- <th>Costo</th> -->
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for encargo in encargos_proceso %}
                        <tr>
                            <td class="color-grey">{{ encargo.Folio }}</td>
                            <td>{{ encargo.cliente }}</td>
                            <!-- <td>{{ encargo.fecha_encargo }}</td> -->
                            <td>{{ encargo.fecha_entrega }}</td>
                            <!-- <td>{{ encargo.costo }}</td> -->
                            <td>{{ encargo.observaciones }}</td>
                            <td>
                               <!-- <button class="btn-cambiar-completado btn btn-success" data-id="{{ encargo.id }}">Cambiar Estado</button>-->
                                <<button class="btn-cambiar-encargo btn btn-primary" data-id="{{ encargo.id }}">Cambiar Encargo</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>

            <div class="tab-pane fade" id="completado" role="tabpanel" aria-labelledby="completado-tab">
                <table class="table">

                    <thead>
                        <tr>
                            <th class="color-grey">Folio del Encargo</th>
                            <th>cliente</th>
                            <!-- <th>Fecha de Encargo</th> -->
                            <th>Fecha de Entrega</th>
                            <th>Adeudo</th>
                            <th>Estado de Pago</th>
                            <th>Actualizar Encargo</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for encargo in encargos_completado %}
                        <tr>
                            <td class="color-grey">{{ encargo.Folio }}</td>
                            <td>{{ encargo.cliente }}</td>
                            <!-- <td>{{ encargo.fecha_encargo }}</td> -->
                            <td>{{ encargo.fecha_entrega }}</td>
                            <td>{{ encargo.adeudo }}</td>
                            <td>
                                {% if encargo.adeudo == 0 %}
                                <img src="{% static 'img/icons8-comprobado-30.png' %}" alt="comprobado">
                                {% else %}
                                <img src="{% static 'img/icons8-no-30.png' %}" alt="no">
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn-cambiar-encargo btn btn-primary" data-id="{{ encargo.id }}">Cambiar Encargo</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>

            <div class="tab-pane fade" id="entregado" role="tabpanel" aria-labelledby="completado-tab">
                <table class="table">

                    <thead>
                        <tr>
                            <th class="color-grey">Folio del Encargo</th>

                            <th>cliente</th>
                            <th>Fecha de Entrega</th>
                            <th>Costo</th>
                            <th>Estado de Pago</th>
                            <th></th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for encargo in encargos_entregados %}
                        <tr>
                            <td class="color-grey">{{ encargo.Folio }}</td>
                            <td>{{ encargo.cliente }}</td>
                            <td>{{ encargo.fecha_entrega }}</td>
                            <td>{{ encargo.costo }}</td>
                            <td>
                                {% if encargo.adeudo == 0 %}
                                <img src="{% static 'img/icons8-comprobado-30.png' %}" alt="comprobado">
                                {% else %}
                                <img src="{% static 'img/icons8-no-30.png' %}" alt="no">
                                {% endif %}
                            </td>
                            <td> 
                                {% if encargo.adeudo != 0 %}
                                <button class="btn-cambiar-encargo btn btn-primary" data-id="{{ encargo.id }}">Validar encargo</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>

        </div>
    </div>

    <!-- Seccion de los modal para el funcionamiento de la pagina -->
    <!-- Modal para cambiar estado -->
    <div class="modal fade" id="CambiarEstado" tabindex="-1" aria-labelledby="CambiarEstadoLabel" aria-hidden="true">
        <div class="modal-dialog">

            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="CambiarEstadoLabel">Cambiar Estado del Encargo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <form id="CambiarEstado">

                        <div class="mb-3" id="choseeContainer">
                            <label for="selectEstado" class="form-label">Seleccione el nuevo estado</label>
                            <select class="form-select" id="selectEstadot" name="estado">
                                <option value="ENCARGO">Encargo</option>
                                <option value="EN_PROCESO">En Proceso</option>
                                <option value="COMPLETADO">Completado</option>
                                <option value="ENTREGADO">Entregado</option>
                            </select>
                        </div>

                        <div class="mb-3" id="estadoPagoContainer">
                            <label for="estadoPago" class="form-label">Adeudo del Encargo</label>
                            <input type="number" class="form-control" id="estadoPago" name="estadoPago" step="0.01" readonly>
                        </div>

                        <div class="mb-3" id="nuevoAdeudoContainer">
                            <label for="nuevoAdeudo" class="form-label">Ingreso del Pago</label>
                            <input type="number" class="form-control" id="nuevoAdeudo" name="nuevoAdeudo" step="0.01">
                        </div>

                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>

                    </form>
                </div>

            </div>

        </div>
    </div>

    <!-- Modal para generar el pago -->
    <div class="modal fade" id="modalAgregarEncargo" tabindex="-1" aria-labelledby="modalAgregarEncargoLabel" aria-hidden="true">
        <div class="modal-dialog">

            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="modalAgregarEncargoLabel">Agregar Encargo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <form id="formAgregarEncargo">

                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="folio" class="form-label">Folio</label>
                            <input type="text" class="form-control" id="folio" name="folio" readonly>
                        </div>

                        <div class="mb-3">
                            <label for="cliente" class="form-label">Clientes</label>
                            <select class="form-select" id="cliente" name="cliente_id">
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}">{{ cliente.nombre }} {{ cliente.apellidos  }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="fecha_encargo" class="form-label">Fecha de Encargo</label>
                            <input type="date" class="form-control" id="fecha_encargo" name="fecha_encargo" value="{{ current_date }}" readonly>
                        </div>

                        <div class="mb-3">
                            <label for="fecha_entrega" class="form-label">Fecha de Entrega</label>
                            <input type="date" class="form-control" id="fecha_entrega" name="fecha_entrega">
                        </div>

                        <div class="mb-3">
                            <label for="costo" class="form-label">Costo</label>
                            <input type="number" class="form-control" id="costo" name="costo" step="0.01">
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="pagadoCheckbox" name="pagadoCheckbox">
                            <label class="form-check-label" for="pagadoCheckbox">¿Pagado?</label>
                        </div>

                        <div class="mb-3">
                            <label for="anticipo" class="form-label">Anticipo</label>
                            <input type="number" class="form-control" id="anticipo" name="anticipo" step="0.01">
                        </div>

                        <div class="mb-3">
                            <label for="adeudo" class="form-label">Adeudo</label>
                            <input type="number" class="form-control" id="adeudo" name="adeudo" step="0.01" readonly>
                        </div>

                        <div class="mb-3">
                            <label for="forma_pago" class="form-label">Metodo de Pago</label>
                            <select class="form-select" id="forma_pago" name="forma_pago">
                                <option value="Efectivo">Efectivo</option>
                                <option value="Tarjeta">Tarjeta</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="observaciones" class="form-label">Descripcion</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="3">{{ encargo.observaciones }}</textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">Guardar</button>

                    </form>
                </div>

            </div>

        </div>
    </div>

    <!-- Modal para generar un ticket -->
    <div class="modal fade" id="modalTicket" tabindex="-1" aria-labelledby="modalTicketLabel" aria-hidden="true">
        <div class="modal-dialog">

            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="modalTicketLabel">Ticket de Venta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body" id="ticketContent">
                    <!-- Carga de contenido  -->
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <!--<button type="button" class="btn btn-primary" onclick="printTickett()">Imprimir</button>-->
                    <button type="button" class="btn-imprime-ticket btn btn-primary" >Imprimir</button>
                </div>

            </div>

        </div>
    </div>

    <!-- Seccion de notificasion -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">

            <div class="toast-header">
                <strong class="me-auto">Notificación</strong>
                <small>Ahora</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>

            <div class="toast-body" id="toastBody">
                Mensaje de notificación aquí.
            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <!--
    <script src="{% static 'js/encargo_actions.js' %}"></script>
    -->

    <script>
        // Operaciones de la seccion encargos
        document.addEventListener('DOMContentLoaded', function() {

            //Variables de los datos a agregar en el control de encargos.
            const formAgregarEncargo = document.getElementById('formAgregarEncargo');
            const folioInput = document.getElementById('folio');
            const fechaEncargoInput = document.getElementById('fecha_encargo');
            const anticipoInput = document.getElementById('anticipo');
            const costoInput = document.getElementById('costo');
            const adeudoInput = document.getElementById('adeudo');
            const pagadoCheckbox = document.getElementById('pagadoCheckbox');
            const forma_pago = document.getElementById('forma_pago');
            const observacionesInput = document.getElementById('observaciones');

            function generarFolio() {
                const now = new Date();
                const folio = now.getFullYear().toString() + 
                            (now.getMonth() + 1).toString().padStart(2, '0') + 
                            now.getDate().toString().padStart(2, '0') + 
                            now.getHours().toString().padStart(2, '0') + 
                            now.getMinutes().toString().padStart(2, '0') + 
                            now.getSeconds().toString().padStart(2, '0');
                folioInput.value = folio;
            }

            function actualizarAdeudo() {
                const costo = parseFloat(costoInput.value) || 0;
                const anticipo = parseFloat(anticipoInput.value) || 0;
                adeudoInput.value = (costo - anticipo).toFixed(2);
            }

            function manejarCheckboxPagado() {
                if (pagadoCheckbox.checked) {
                    anticipoInput.value = costoInput.value;
                    anticipoInput.readOnly = true;
                    actualizarAdeudo();
                } else {
                    anticipoInput.readOnly = false;
                    actualizarAdeudo();
                }
            }

            $('#modalAgregarEncargo').on('show.bs.modal', function() {
                generarFolio();
                fechaEncargoInput.valueAsDate = new Date();
                manejarCheckboxPagado();
                
            });

            anticipoInput.addEventListener('input', actualizarAdeudo);
            costoInput.addEventListener('input', actualizarAdeudo);
            pagadoCheckbox.addEventListener('change', manejarCheckboxPagado);

            formAgregarEncargo.addEventListener('submit', function(event) {
                event.preventDefault();

                const formData = new FormData(formAgregarEncargo);
                fetch('/guardar-encargo/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    console.log(folioInput.value)
                    const toastBody = document.getElementById('toastBody');
                    toastBody.textContent = data.message;
                    const toast = new bootstrap.Toast(document.getElementById('toastNotification'));
                    toast.show();

                    //Seccion para generar el conteido del ticket 
                    generarTicket(folioInput.value, fechaEncargoInput.valueAsDate, forma_pago.value, costoInput.value, anticipoInput.value, observacionesInput.value);
                    var modalTicket = new bootstrap.Modal(document.getElementById('modalTicket'));
                    modalTicket.show();

                    formAgregarEncargo.reset();
                    $('#modalAgregarEncargo').modal('hide');
                    //setTimeout(() => location.reload(), 2000);
                })
                .catch(error => console.error('Error:', error));
            });

            // Función para generar el contenido del ticket
            function generarTicket(folioInput, fechaEncargoInput, forma_pago, costoInput, anticipoInput, observacionesInput) {
                var ticketContent = document.getElementById('ticketContent');
                ticketContent.innerHTML = `
                    <div style="text-align: right;, font-family: 'Semibold', Courier, monospace">
                        <img src={% static 'img/LAVANDEROS.ico' %} alt="Lavanderos" style="width: 100px; height: auto;"/>
                    </div>
                    
                    <h2 style="text-align: center;">Lavanderos</h2>
                    <p>WhatsApp: 7222947337</p>
                    <p>Teléfono: 7229365461</p>
                    <p>Calle Paseo de los Matlatzincas 235</p>
                    <p>Col. Lomas Altas, Toluca, México</p>

                    <h4>Informacion del encargo:</h4>
                    <p>Folio: ${folioInput} </p>
                    <p>Método de Pago: ${forma_pago}</p>
                    <p>Descripcion: ${observacionesInput}</p>

                    <p>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</p>

                    <p>Cantidad cubierta: ${anticipoInput}</p>
                    <p class="total" style="text-align: right;">Total: $${parseFloat(costoInput).toFixed(2)}</p>

                    <p>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</p>
                    
                    <p style="font-style: italic; text-align: center;">"Porque NO toda la ropa sucia se lava en casa"</p>
                    <p style="font-size: 0.8em; text-align: justify;"><i>"Lavanderos"</i>,después de <b> 2 meses</b> la empresa no se hace responsable de las prendas. Por su comprensión, gracias.</p>
                `;
            }

            $('.btn-imprime-ticket').on('click', function printTickett() {
                var printContents = document.getElementById('ticketContent').innerHTML;
                var originalContents = document.body.innerHTML;

                document.body.innerHTML = printContents;
                window.print();
                document.body.innerHTML = originalContents;

                // Reload the page after printing
                setTimeout(function() {
                    location.reload();
                }, 1000);
            })

            // Validación de los datos de encargo
            $('.btn-cambiar-encargo').on('click', function() {
                const encargoId = $(this).data('id');
                const modal = $('#CambiarEstado');
                modal.modal('show');

                $.ajax({
                    type: 'GET',
                    url: '/cambiar-estado-encargo/' + encargoId + '/',
                    success: function(response) {
                        const adeudo = response.adeudo;
                        const estado = response.estado;
                        $('#estadoPago').val(adeudo);

                        if (adeudo > 0) {
                            $('#nuevoAdeudoContainer').show();
                        } else {
                            $('#nuevoAdeudoContainer').hide();
                        }

                    
                        if (estado === 'ENTREGADO') {
                            $('#choseeContainer').show(); 
                            $('#nuevoAdeudoContainer').show(); 
                            $('#estadoPagoContainer').show(); 
                        } else {
                            $('#choseeContainer').show();
                            $('#nuevoAdeudoContainer').hide(); 
                            $('#estadoPagoContainer').hide(); 
                        }
                    },
                    error: function(xhr, errmsg, err) {
                        console.log(xhr.status + ": " + xhr.responseText);
                    }
                });

                $('#CambiarEstado').off('submit').on('submit', function(e) {
                    e.preventDefault();
                
                    const nuevoAdeudo = parseFloat($('#nuevoAdeudo').val()) || 0;
                    const estadoPago = parseFloat($('#estadoPago').val());
                    const estadoSeleccionado = $('#selectEstadot').val(); 
                    const entregado = estadoSeleccionado === 'ENTREGADO'; 
                
                    // Solo calculamos nuevo adeudo si estamos en estado 'ENTREGADO'
                    const adeudoFinal = estadoSeleccionado === 'ENTREGADO' ? estadoPago - nuevoAdeudo : estadoPago;
                
                    $.ajax({
                        type: 'POST',
                        url: '/cambiar-estado-encargo/' + encargoId + '/',
                        data: {
                            estado: estadoSeleccionado,
                            ingreso: nuevoAdeudo,
                            nuevo_adeudo: adeudoFinal,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        success: function(response) {
                            modal.modal('hide');
                            showToast('Encargo actualizado', 'success');
                            setTimeout(() => location.reload(), 3000);
                        },
                        error: function(xhr, errmsg, err) {
                            console.log(xhr.status + ": " + xhr.responseText);
                            showToast('Error al actualizar el encargo', 'error');
                        }
                    });
                });
                
            });

            function showToast(message, type) {
                const toastBody = document.getElementById('toastBody');
                toastBody.innerText = message;
                const toast = new bootstrap.Toast(document.getElementById('toastNotification'));
                toast.show();
            }
        });
     
        
    </script>

</body>
</html>